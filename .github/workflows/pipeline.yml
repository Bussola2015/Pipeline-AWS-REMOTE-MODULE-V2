name: "AWS Infrastructure Pipeline"

on:
  push:
    branches: [ main ]
    paths:
      - 'environments/dev/**'
    #   - '.github/workflows/**'  #se alterar o pipeline, roda o terraform apply
    #   - '.tflint.hcl'           #se alterar as regras do tflint, roda o terraform apply

  pull_request: 
    branches: [ main ]
    paths:
      - 'environments/dev/**'

jobs:
  pipeline:
    name: "Terraform Action"
    runs-on: ubuntu-22.04
    env:
      WORKING_DIR: ./environments/dev
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

    steps:
      # git clone no meu repo para pegar o c√≥digo do terraform  
      - name: Checkout
        uses: actions/checkout@v4
      # bin√°rio do terraform para rodar os comandos do terraform, libs, etc
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # --- TFLINT SETUP ---
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.61.0  

      # Cria pasta de cache dos plugins do terraform para acelerar as execu√ß√µes futuras. O cache √© salvo entre as execu√ß√µes do pipeline, e a chave do cache √© baseada no conte√∫do do arquivo .terraform.lock.hcl, que lista as vers√µes exatas dos provedores usados no projeto. Assim, se as depend√™ncias mudarem, o cache ser√° invalidado e atualizado.
      - name: Create Plugin Cache Dir
        run: mkdir -p ~/.terraform.d/plugin-cache

      - name: Cache Terraform Plugins
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-aws-${{ hashFiles('**/.terraform.lock.hcl') }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}

    # Esse passo fa√ßo manualmente para garantir que o c√≥digo esteja formatado antes de rodar o Plan e o Apply. O Check de formata√ß√£o √© importante para manter um padr√£o de c√≥digo, mas o Format em si pode ser opcional dependendo do seu fluxo de trabalho. Se voc√™ quiser que o pipeline corrija automaticamente a formata√ß√£o, pode descomentar o passo do Terraform Format.
    #   - name: Terraform Format
    #     run: terraform fmt -recursive
    #     working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform Format Check
        run: terraform fmt -check
        working-directory: ${{ env.WORKING_DIR }}
      # ---------------------------------------  

      - name: Init TFLint
        run: tflint --init --config ../../.tflint.hcl
        working-directory: ${{ env.WORKING_DIR }}

      - name: Run TFLint
        run: tflint -f compact --config ../../.tflint.hcl
        working-directory: ${{ env.WORKING_DIR }}

    # --- NOVO: CHECKOV (Com bloqueio) ---
    #   - name: Teste de Seguran√ßa com Checkov
    #     uses: bridgecrewio/checkov-action@master
    #     with:
    #       directory: ${{ env.WORKING_DIR }}
    #       soft_fail: false # TRAVA o pipelin e se houver erro de seguran√ßa - Se true, termina o pipeline com sucesso mesmo se houver erros de seguran√ßa, o que √© √∫til durante a fase de configura√ß√£o inicial do Checkov ou enquanto voc√™ corrige os avisos. Depois de corrigir os problemas, voc√™ pode definir isso como false para garantir que o pipeline falhe se forem encontrados novos problemas de seguran√ßa. Isso ajuda a manter um padr√£o de seguran√ßa mais rigoroso no futuro.
    #       framework: terraform
    #       output_format: cli # <-- (Este √© o padr√£o se voc√™ omitir)

      # Terraform Apply     
      - name: Terraform Plan
        run: terraform plan -var="admin_ip=${{ secrets.MY_PERSONAL_IP }}" -var-file="terraform.tfvars"
        working-directory: ${{ env.WORKING_DIR }}

      # Esta condi√ß√£o garante que o Apply S√ì rode quando o c√≥digo entrar na MAIN
      # (Seja por push direto ou por MERGE de um PR)
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -var="admin_ip=${{ secrets.MY_PERSONAL_IP }}" -var-file="terraform.tfvars" -auto-approve
        working-directory: ${{ env.WORKING_DIR }}

      - name: Upload SSH Key
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ssh-key-debian
          path: ${{ env.WORKING_DIR }}/aws-key-dev.pem

      # --- NOVO: NOTIFICA√á√ÉO TELEGRAM ---
      - name: Notificar Telegram
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ‚òÅÔ∏è *Pipeline AWS:* `${{ github.workflow }}`
            üìä *Status:* ${{ job.status == 'success' && '‚úÖ SUCESSO' || '‚ùå FALHA' }}
            üìÇ *Projeto:* `${{ github.repository }}`
            üîó [Ver Detalhes](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})